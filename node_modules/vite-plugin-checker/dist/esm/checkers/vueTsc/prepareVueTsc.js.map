{"version":3,"sources":["../../../../src/checkers/vueTsc/prepareVueTsc.ts"],"sourcesContent":["import fsExtra from 'fs-extra'\nimport { createRequire } from 'module'\nimport path, { dirname } from 'path'\nimport { fileURLToPath } from 'url'\nimport semver from 'semver'\nimport { writeFile, access, readFile, rm } from 'fs/promises'\n\nconst { copy, mkdir } = fsExtra\nconst _require = createRequire(import.meta.url)\n\n// isomorphic __dirname https://antfu.me/posts/isomorphic-dirname\nconst _filename = fileURLToPath(import.meta.url)\nconst _dirname = dirname(_filename)\nconst proxyApiPath = _require.resolve('vue-tsc/out/index')\n\nexport async function prepareVueTsc() {\n  // 1. copy typescript to folder\n  const targetTsDir = path.resolve(_dirname, 'typescript-vue-tsc')\n  const vueTscFlagFile = path.resolve(targetTsDir, 'vue-tsc-resolve-path')\n  const currTsVersion = _require('typescript/package.json').version\n\n  let shouldBuildFixture = true\n  try {\n    await access(targetTsDir)\n    const targetTsVersion = _require(path.resolve(targetTsDir, 'package.json')).version\n    // check fixture versions before re-use\n    await access(vueTscFlagFile)\n    const fixtureFlagContent = await readFile(vueTscFlagFile, 'utf8')\n    if (targetTsVersion === currTsVersion && fixtureFlagContent === proxyApiPath) {\n      shouldBuildFixture = false\n    }\n  } catch (e) {\n    // no matter what error, we should rebuild the fixture\n    shouldBuildFixture = true\n  }\n\n  if (shouldBuildFixture) {\n    await rm(targetTsDir, { force: true, recursive: true })\n    await mkdir(targetTsDir)\n    const sourceTsDir = path.resolve(_require.resolve('typescript'), '../..')\n    await copy(sourceTsDir, targetTsDir)\n    await writeFile(vueTscFlagFile, proxyApiPath)\n\n    // 2. sync modification of lib/tsc.js with vue-tsc\n    await overrideTscJs(\n      _require.resolve(path.resolve(targetTsDir, 'lib/typescript.js')),\n      currTsVersion\n    )\n  }\n\n  return { targetTsDir }\n}\n\nasync function overrideTscJs(tscJsPath: string, version: string) {\n  let tsc = await readFile(tscJsPath, 'utf8')\n  // #region copied from https://github.com/johnsoncodehk/volar/blob/54f7186485d79bc0e9b7ec59ecbc01d681ee5310/vue-language-tools/vue-tsc/bin/vue-tsc.js\n  // add *.vue files to allow extensions\n  tryReplace(/supportedTSExtensions = .*(?=;)/, (s: string) => s + '.concat([[\".vue\"]])')\n  tryReplace(/supportedJSExtensions = .*(?=;)/, (s: string) => s + '.concat([[\".vue\"]])')\n  tryReplace(/allSupportedExtensions = .*(?=;)/, (s: string) => s + '.concat([[\".vue\"]])')\n\n  // proxy createProgram apis\n  tryReplace(\n    /function createProgram\\(.+\\) {/,\n    (s: string) =>\n      s + ` return require(${JSON.stringify(proxyApiPath)}).createProgram(...arguments);`\n  )\n\n  // patches logic for checking root file extension in build program for incremental builds\n  if (semver.gt(version, '5.0.0')) {\n    tryReplace(\n      `for (const existingRoot of buildInfoVersionMap.roots) {`,\n      `for (const existingRoot of buildInfoVersionMap.roots\n\t\t\t\t.filter(file => !file.toLowerCase().includes('__vls_'))\n\t\t\t\t.map(file => file.replace(/\\.vue\\.(j|t)sx?$/i, '.vue'))\n\t\t\t) {`\n    )\n  }\n\n  function tryReplace(search: any, replace: any) {\n    const before = tsc\n    tsc = tsc.replace(search, replace)\n    const after = tsc\n    if (after === before) {\n      throw 'Search string not found: ' + JSON.stringify(search.toString())\n    }\n  }\n  // #endregion\n\n  await writeFile(tscJsPath, tsc)\n}\n"],"mappings":"AAAA,OAAO,aAAa;AACpB,SAAS,qBAAqB;AAC9B,OAAO,QAAQ,eAAe;AAC9B,SAAS,qBAAqB;AAC9B,OAAO,YAAY;AACnB,SAAS,WAAW,QAAQ,UAAU,UAAU;AAEhD,MAAM,EAAE,MAAM,MAAM,IAAI;AACxB,MAAM,WAAW,cAAc,YAAY,GAAG;AAG9C,MAAM,YAAY,cAAc,YAAY,GAAG;AAC/C,MAAM,WAAW,QAAQ,SAAS;AAClC,MAAM,eAAe,SAAS,QAAQ,mBAAmB;AAEzD,eAAsB,gBAAgB;AAEpC,QAAM,cAAc,KAAK,QAAQ,UAAU,oBAAoB;AAC/D,QAAM,iBAAiB,KAAK,QAAQ,aAAa,sBAAsB;AACvE,QAAM,gBAAgB,SAAS,yBAAyB,EAAE;AAE1D,MAAI,qBAAqB;AACzB,MAAI;AACF,UAAM,OAAO,WAAW;AACxB,UAAM,kBAAkB,SAAS,KAAK,QAAQ,aAAa,cAAc,CAAC,EAAE;AAE5E,UAAM,OAAO,cAAc;AAC3B,UAAM,qBAAqB,MAAM,SAAS,gBAAgB,MAAM;AAChE,QAAI,oBAAoB,iBAAiB,uBAAuB,cAAc;AAC5E,2BAAqB;AAAA,IACvB;AAAA,EACF,SAAS,GAAP;AAEA,yBAAqB;AAAA,EACvB;AAEA,MAAI,oBAAoB;AACtB,UAAM,GAAG,aAAa,EAAE,OAAO,MAAM,WAAW,KAAK,CAAC;AACtD,UAAM,MAAM,WAAW;AACvB,UAAM,cAAc,KAAK,QAAQ,SAAS,QAAQ,YAAY,GAAG,OAAO;AACxE,UAAM,KAAK,aAAa,WAAW;AACnC,UAAM,UAAU,gBAAgB,YAAY;AAG5C,UAAM;AAAA,MACJ,SAAS,QAAQ,KAAK,QAAQ,aAAa,mBAAmB,CAAC;AAAA,MAC/D;AAAA,IACF;AAAA,EACF;AAEA,SAAO,EAAE,YAAY;AACvB;AAEA,eAAe,cAAc,WAAmB,SAAiB;AAC/D,MAAI,MAAM,MAAM,SAAS,WAAW,MAAM;AAG1C,aAAW,mCAAmC,CAAC,MAAc,IAAI,qBAAqB;AACtF,aAAW,mCAAmC,CAAC,MAAc,IAAI,qBAAqB;AACtF,aAAW,oCAAoC,CAAC,MAAc,IAAI,qBAAqB;AAGvF;AAAA,IACE;AAAA,IACA,CAAC,MACC,IAAI,mBAAmB,KAAK,UAAU,YAAY;AAAA,EACtD;AAGA,MAAI,OAAO,GAAG,SAAS,OAAO,GAAG;AAC/B;AAAA,MACE;AAAA,MACA;AAAA;AAAA;AAAA;AAAA,IAIF;AAAA,EACF;AAEA,WAAS,WAAW,QAAa,SAAc;AAC7C,UAAM,SAAS;AACf,UAAM,IAAI,QAAQ,QAAQ,OAAO;AACjC,UAAM,QAAQ;AACd,QAAI,UAAU,QAAQ;AACpB,YAAM,8BAA8B,KAAK,UAAU,OAAO,SAAS,CAAC;AAAA,IACtE;AAAA,EACF;AAGA,QAAM,UAAU,WAAW,GAAG;AAChC;","names":[]}